<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BFC VIP</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      padding: 0;
      margin: 0;
      background: linear-gradient(145deg, #1a1a1a 0%, #2c3e50 100%);
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    h1, h2 {
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      font-weight: 700;
      color: #facc15;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 2rem;
    }
    h2 {
      font-size: 1.75rem;
      margin: 1.5rem 0;
    }
    .container, .admin-container, .login-container {
      max-width: 700px;
      width: 95%;
      margin: 3rem auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .login-container {
      max-width: 450px;
      margin: 6rem auto;
    }
    input, select {
      width: 100%;
      padding: 14px;
      margin: 0.75rem 0;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #facc15;
      box-shadow: 0 0 8px rgba(250, 204, 21, 0.5);
    }
    input::placeholder {
      color: #94a3b8;
    }
    button {
      width: 100%;
      padding: 14px;
      margin: 0.75rem 0;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .login-container button {
      background: linear-gradient(90deg, #facc15, #eab308);
      color: #1a1a1a;
    }
    .login-container button:hover {
      background: linear-gradient(90deg, #eab308, #ca8a04);
    }
    .error {
      color: #f87171;
      font-size: 0.9rem;
      text-align: center;
      margin-top: 1rem;
    }
    .timer {
      text-align: center;
      font-size: 1.1rem;
      color: #94a3b8;
      margin-bottom: 1.5rem;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin: 1.5rem 0;
    }
    .admin-container button {
      background: #10b981;
      color: #fff;
    }
    .admin-container button:hover {
      background: #059669;
    }
    .admin-user-list div {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1rem;
    }
    .admin-user-list button {
      width: auto;
      padding: 8px 20px;
      font-size: 0.9rem;
    }
    .admin-user-list button.demote {
      background: #f87171;
    }
    .admin-user-list button.demote:hover {
      background: #dc2626;
    }
    .player {
      background: linear-gradient(90deg, #3b82f6, #1e40af);
      color: #fff;
    }
    .player:hover {
      background: linear-gradient(90deg, #2563eb, #1e3a8a);
    }
    .banker {
      background: linear-gradient(90deg, #e11d48, #9f1239);
      color: #fff;
    }
    .banker:hover {
      background: linear-gradient(90deg, #be123c, #881337);
    }
    .clear-all {
      background: #f87171;
      color: #fff;
    }
    .clear-all:hover {
      background: #dc2626;
    }
    .undo {
      background: #6b7280;
      color: #fff;
    }
    .undo:hover {
      background: #4b5563;
    }
    .set-bet, .reset-bet, .mm-action {
      background: #6b7280;
      color: #fff;
    }
    .set-bet:hover, .reset-bet:hover, .mm-action:hover {
      background: #4b5563;
    }
    .toggle-section {
      background: linear-gradient(90deg, #6b7280, #4b5563);
      color: #fff;
      padding: 12px;
      width: 100%;
      text-align: center;
      font-weight: 500;
    }
    .toggle-section:hover {
      background: linear-gradient(90deg, #4b5563, #374151);
    }
    .collapsible {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .collapsible.show {
      display: flex;
      opacity: 1;
    }
    .prediction {
      font-weight: 500;
      font-size: 1.5rem;
      text-align: center;
      margin: 1.5rem 0;
      color: #facc15;
    }
    .shoe-type {
      text-align: center;
      font-size: 1rem;
      color: #94a3b8;
      margin: 0.75rem 0;
    }
    .history {
      margin-top: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
    }
    .history div {
      width: 48px;
      height: 48px;
      line-height: 48px;
      text-align: center;
      color: #fff;
      font-weight: 500;
      border-radius: 12px;
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .history div:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .P {
      background: #3b82f6;
    }
    .B {
      background: #e11d48;
    }
    .W::after, .L::after {
      content: attr(data-outcome);
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 0.85rem;
      color: #fff;
      background: #10b981;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
    }
    .L::after {
      background: #f87171;
    }
    .stats {
      padding: 1.5rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-top: 1.5rem;
    }
    .section {
      font-size: 1.2rem;
      font-weight: 500;
      margin: 1rem 0;
      color: #e2e8f0;
    }
    .bet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    label {
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #e2e8f0;
    }
    .cycle-reset {
      color: #10b981;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      .container, .admin-container, .login-container {
        width: 92%;
        padding: 2rem;
      }
      .flex-row, .bet-controls {
        flex-direction: column;
        align-items: stretch;
      }
      input, select, button {
        width: 100%;
        font-size: 0.95rem;
      }
      h1 {
        font-size: 2rem;
      }
      h2 {
        font-size: 1.5rem;
      }
      .history div {
        width: 40px;
        height: 40px;
        line-height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <h1>BFC VIP Login</h1>
    <input type="text" id="username" placeholder="Enter Username" aria-label="Username">
    <input type="password" id="password" placeholder="Enter Password" aria-label="Password">
    <button onclick="login()" aria-label="Login">Sign In</button>
    <div class="error" id="loginError"></div>
  </div>

  <div class="admin-container" id="adminContainer" style="display: none;">
    <h1>BFC VIP Admin Panel</h1>
    <div class="flex-row">
      <button onclick="logout()" aria-label="Logout">Sign Out</button>
    </div>
    <h2>Create New User</h2>
    <input type="text" id="newUsername" placeholder="New Username" aria-label="New Username">
    <input type="password" id="newPassword" placeholder="New Password" aria-label="New Password">
    <select id="newUserSubscriptionDuration" aria-label="Select subscription duration for new user">
      <option value="1">1 Day</option>
      <option value="7">7 Days</option>
      <option value="30">30 Days</option>
    </select>
    <button onclick="createUser()" aria-label="Create user">Create User</button>
    <div class="error" id="createUserError"></div>
    <h2>Manage User Subscriptions</h2>
    <div class="admin-user-list" id="userList"></div>
    <h2>Set Subscription</h2>
    <input type="text" id="adminUsername" placeholder="Username" aria-label="Username to manage">
    <select id="subscriptionDuration" aria-label="Select subscription duration">
      <option value="1">1 Day</option>
      <option value="7">7 Days</option>
      <option value="30">30 Days</option>
    </select>
    <button onclick="setSubscription()" aria-label="Set subscription">Set Subscription</button>
    <div class="error" id="adminError"></div>
  </div>

  <div class="container" id="appContainer" style="display: none;">
    <h1>BFC VIP Dashboard</h1>
    <div class="timer" id="timerDisplay">Access expires: -</div>
    <div class="flex-row">
      <button onclick="logout()" aria-label="Logout">Sign Out</button>
    </div>
    <div class="flex-row">
      <button class="player" onclick="recordResult('P')" aria-label="Record Player result">Player</button>
      <button class="banker" onclick="recordResult('B')" aria-label="Record Banker result">Banker</button>
      <button class="clear-all" onclick="clearAll()" aria-label="Clear all data">Clear All</button>
      <button class="undo" onclick="undo()" aria-label="Undo last action">Undo</button>
    </div>
    <div class="prediction" id="prediction">Waiting for input...</div>
    <div class="shoe-type" id="shoeType">Detected Pattern: N/A</div>
    <div class="history" id="historyDisplay"></div>
    <div class="stats">
      <div class="section" id="currentWager">üíµ Current Bet: 0</div>
      <div class="section" id="bankrollDisplay">üíº Balance: - | Profit: -</div>
      <div class="section" id="streakInfo"></div>
      <div class="section">
        ‚úÖ <span id="wins">0</span> | ‚ùå <span id="losses">0</span> | üìä <span id="accuracy">0%</span>
      </div>
      <div class="bet-controls">
        <label><span>Bankroll</span><input type="number" id="bankrollInput" placeholder="Enter Bankroll" min="0.01" step="0.01" aria-label="Set bankroll"></label>
        <label><span>Unit Value</span><input type="number" id="basebetInput" placeholder="Unit Value ($)" min="0.01" step="0.01" aria-label="Set base unit"></label>
        <label>
          <select id="stopProfitType" aria-label="Select stop profit type">
            <option value="currency">$</option>
            <option value="percentage">%</option>
          </select>
          <input type="number" id="stopProfitInput" placeholder="Stop Profit" min="0" step="0.01" aria-label="Set stop profit">
        </label>
        <button class="set-bet" onclick="setBankroll()" aria-label="Set bankroll and bet">Set</button>
      </div>
      <button class="toggle-section" onclick="toggleAdvanced()" aria-label="Toggle advanced controls">Show Advanced</button>
      <div class="flex-row collapsible" id="advancedControls">
        <button class="reset-bet" onclick="resetBet()" aria-label="Reset bet">Reset Bet</button>
        <button class="mm-action" onclick="saveMemory()" aria-label="Save state">üíæ Save</button>
        <button class="mm-action" onclick="loadMemory()" aria-label="Load state">üì• Load</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration (replace with your actual config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // State Management
    let state = {
      history: [],
      outcomes: [],
      wins: 0,
      losses: 0,
      baseUnit: 0,
      startBankroll: 0,
      currentBankroll: 0,
      betState: { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] },
      stopProfitType: 'percentage',
      stopProfitValue: 0,
      stopProfitEffective: 0,
      stopProfitReached: false
    };
    let snapshots = [];
    let saveTimeout = null;
    let currentUser = null;
    let timerInterval = null;

    // User database with subscription info
    const userDatabase = JSON.parse(localStorage.getItem('bfcUsers')) || {};
    const ADMIN_USERNAME = 'admin';

    function formatTimeRemaining(ms) {
      if (!ms || ms <= 0) return 'Expired';
      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      return `${days}d ${hours}h ${minutes}m`;
    }

    function updateTimer() {
      if (!currentUser || !userDatabase[currentUser]?.accessExpires) return;
      const now = Date.now();
      const timeLeft = userDatabase[currentUser].accessExpires - now;
      document.getElementById('timerDisplay').innerText = `Access expires: ${formatTimeRemaining(timeLeft)}`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        logout();
        alert('Your subscription has expired. Contact an admin to renew.');
      }
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');

      if (!username || !password) {
        errorDiv.innerText = 'Please enter both username and password';
        return;
      }

      try {
        const email = `${username}@bfcvip.com`;
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = username;

        if (!userDatabase[username]) {
          userDatabase[username] = {
            state: JSON.parse(JSON.stringify(state)),
            accessExpires: null,
            isAdmin: username === ADMIN_USERNAME
          };
          localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
        }

        if (userDatabase[username].isAdmin) {
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('adminContainer').style.display = 'block';
          document.getElementById('appContainer').style.display = 'none';
          updateAdminUserList();
        } else {
          if (!userDatabase[username].accessExpires || userDatabase[username].accessExpires < Date.now()) {
            errorDiv.innerText = 'Your subscription has expired or is not set. Contact an admin.';
            await auth.signOut();
            return;
          }
          state = userDatabase[username].state;
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('appContainer').style.display = 'block';
          document.getElementById('adminContainer').style.display = 'none';
          updateDisplay();
          updateTimer();
          timerInterval = setInterval(updateTimer, 60000);
        }
      } catch (error) {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found') {
          errorDiv.innerText = 'User does not exist. Contact admin to create an account.';
        } else if (error.code === 'auth/wrong-password') {
          errorDiv.innerText = 'Incorrect password';
        } else {
          errorDiv.innerText = 'Login failed: ' + error.message;
        }
      }
    }

    async function logout() {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('Logout error:', error);
      }
      saveMemory();
      clearInterval(timerInterval);
      currentUser = null;
      state = {
        history: [],
        outcomes: [],
        wins: 0,
        losses: 0,
        baseUnit: 0,
        startBankroll: 0,
        currentBankroll: 0,
        betState: { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] },
        stopProfitType: 'percentage',
        stopProfitValue: 0,
        stopProfitEffective: 0,
        stopProfitReached: false
      };
      snapshots = [];
      document.getElementById('loginContainer').style.display = 'block';
      document.getElementById('appContainer').style.display = 'none';
      document.getElementById('adminContainer').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').innerText = '';
      document.getElementById('timerDisplay').innerText = 'Access expires: -';
    }

    function createUser() {
      if (currentUser !== ADMIN_USERNAME) {
        alert('Only admin can create users');
        return;
      }
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const durationDays = parseInt(document.getElementById('newUserSubscriptionDuration').value);
      const errorDiv = document.getElementById('createUserError');

      if (!username || !password) {
        errorDiv.innerText = 'Please enter both username and password';
        return;
      }
      if (userDatabase[username]) {
        errorDiv.innerText = 'Username already exists';
        return;
      }
      if (username === ADMIN_USERNAME) {
        errorDiv.innerText = 'Cannot create user with admin username';
        return;
      }

      userDatabase[username] = {
        state: JSON.parse(JSON.stringify(state)),
        accessExpires: Date.now() + durationDays * 24 * 60 * 60 * 1000,
        isAdmin: false
      };
      localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
      errorDiv.innerText = `User ${username} created with ${durationDays}-day subscription`;
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
      updateAdminUserList();
    }

    function toggleAdminStatus(username) {
      if (currentUser !== ADMIN_USERNAME) {
        alert('Only admin can modify admin status');
        return;
      }
      if (!userDatabase[username]) {
        document.getElementById('adminError').innerText = 'User does not exist';
        return;
      }
      if (username === ADMIN_USERNAME) {
        document.getElementById('adminError').innerText = 'Cannot modify admin status for primary admin';
        return;
      }

      userDatabase[username].isAdmin = !userDatabase[username].isAdmin;
      userDatabase[username].accessExpires = userDatabase[username].isAdmin ? null : 0;
      localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
      document.getElementById('adminError').innerText = `${username} ${userDatabase[username].isAdmin ? 'promoted to admin' : 'demoted to user'}`;
      updateAdminUserList();
    }

    function updateAdminUserList() {
      const userListDiv = document.getElementById('userList');
      userListDiv.innerHTML = '';
      Object.keys(userDatabase).forEach(user => {
        if (user === ADMIN_USERNAME) return;
        const userDiv = document.createElement('div');
        const expires = userDatabase[user].accessExpires;
        const isAdmin = userDatabase[user].isAdmin;
        userDiv.innerHTML = `${user} - Access: ${isAdmin ? 'Admin (No Expiration)' : expires ? formatTimeRemaining(expires - Date.now()) : 'Not Set'}`;
        const adminButton = document.createElement('button');
        adminButton.innerText = isAdmin ? 'Demote' : 'Make Admin';
        adminButton.className = isAdmin ? 'demote' : '';
        adminButton.onclick = () => toggleAdminStatus(user);
        userDiv.appendChild(adminButton);
        userListDiv.appendChild(userDiv);
      });
    }

    function setSubscription() {
      if (currentUser !== ADMIN_USERNAME) {
        alert('Only admin can set subscriptions');
        return;
      }
      const username = document.getElementById('adminUsername').value.trim();
      const durationDays = parseInt(document.getElementById('subscriptionDuration').value);
      const errorDiv = document.getElementById('adminError');

      if (!username) {
        errorDiv.innerText = 'Please enter a username';
        return;
      }
      if (!userDatabase[username]) {
        errorDiv.innerText = 'User does not exist';
        return;
      }
      if (userDatabase[username].isAdmin) {
        errorDiv.innerText = 'Cannot set subscription for admin users';
        return;
      }

      userDatabase[username].accessExpires = Date.now() + durationDays * 24 * 60 * 60 * 1000;
      localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
      errorDiv.innerText = `Subscription set for ${username} to ${durationDays} days`;
      updateAdminUserList();
    }

    function getCurrentPrediction() {
      if (state.history.length < 5) return null;

      const last5 = state.history.slice(-5);
      const countB = last5.filter(x => x === 'B').length;
      const countP = last5.filter(x => x === 'P').length;

      if (last5.every((v, i, a) => i === 0 || v !== a[i - 1])) {
        return last5.at(-1) === 'B' ? 'P' : 'B';
      } else if (last5.slice(-3).every(v => v === last5.at(-1))) {
        return last5.at(-1);
      } else if (countB === 4 || countP === 4) {
        return countB > countP ? 'P' : 'B';
      } else {
        return state.history.slice(-3).filter(x => x === 'B').length < 2 ? 'B' : 'P';
      }
    }

    function recordResult(result) {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      if (!state.baseUnit || !state.startBankroll) {
        alert('Set bankroll/unit first');
        return;
      }

      const prediction = getCurrentPrediction();
      snapshots.push(JSON.parse(JSON.stringify(state)));

      if (!prediction) {
        state.history.push(result);
        alert('No prediction available yet (need 5 hands). No wager placed.');
        saveMemoryFast();
        updateDisplay();
        return;
      }

      if (state.stopProfitReached) {
        alert('Stop profit reached');
        return;
      }
      const wager = getWager();
      if (wager > state.currentBankroll) {
        alert('Insufficient balance');
        return;
      }

      state.history.push(result);
      const outcome = result === prediction ? 'win' : 'loss';
      state.outcomes.push(outcome === 'win' ? 'W' : 'L');
      if (outcome === 'win') {
        handleWin();
        state.wins++;
      } else {
        handleLoss();
        state.losses++;
      }
      if (state.stopProfitEffective > 0 && state.currentBankroll - state.startBankroll >= state.stopProfitEffective) {
        state.stopProfitReached = true;
      }
      saveMemoryFast();
      updateDisplay();
    }

    function undo() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      if (snapshots.length) {
        state = snapshots.pop();
        saveMemoryFast();
        updateDisplay();
      }
    }

    function clearAll() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      if (confirm('Reset all data?')) {
        snapshots.push(JSON.parse(JSON.stringify(state)));
        state.history = [];
        state.outcomes = [];
        state.wins = 0;
        state.losses = 0;
        saveMemoryFast();
        document.getElementById('prediction').innerText = 'Waiting for input...';
        document.getElementById('shoeType').innerText = 'Detected Pattern: N/A';
        document.getElementById('historyDisplay').innerHTML = '';
        updateMMDisplay();
      }
    }

    function setBankroll() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      const bankroll = parseFloat(document.getElementById('bankrollInput').value);
      const unit = parseFloat(document.getElementById('basebetInput').value);
      const stopProfit = parseFloat(document.getElementById('stopProfitInput').value) || 0;
      state.stopProfitType = document.getElementById('stopProfitType').value;

      if (isNaN(bankroll) || bankroll <= 0 || isNaN(unit) || unit <= 0) {
        alert('Invalid bankroll or unit value');
        return;
      }
      if (stopProfit < 0) {
        alert('Invalid stop profit');
        return;
      }

      snapshots.push(JSON.parse(JSON.stringify(state)));
      state.startBankroll = bankroll;
      state.baseUnit = unit;
      state.currentBankroll = bankroll;
      state.stopProfitValue = stopProfit;
      state.stopProfitEffective = state.stopProfitType === 'percentage' ? stopProfit / 100 * bankroll : stopProfit;
      state.stopProfitReached = false;
      state.betState = { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] };
      state.wins = 0;
      state.losses = 0;
      state.outcomes = [];
      saveMemoryFast();
      updateMMDisplay();
    }

    function handleWin() {
      const wager = state.baseUnit * state.betState.currentBetUnits;
      state.betState.totalProfit += state.betState.currentBetUnits;
      state.betState.cycleProfit += state.betState.currentBetUnits;
      state.currentBankroll += wager;
      if (state.betState.cycleProfit >= 1) {
        state.betState.currentBetUnits = 1;
        state.betState.cycleProfit = 0;
        state.betState.previousLosses = [];
      } else {
        if (state.betState.previousLosses.length > 0) {
          state.betState.previousLosses.pop();
        }
        const lastLoss = state.betState.previousLosses.length > 0 ? state.betState.previousLosses[state.betState.previousLosses.length - 1] : 1;
        state.betState.currentBetUnits = lastLoss + 1;
      }
    }

    function handleLoss() {
      const wager = state.baseUnit * state.betState.currentBetUnits;
      state.betState.totalProfit -= state.betState.currentBetUnits;
      state.betState.cycleProfit -= state.betState.currentBetUnits;
      state.betState.previousLosses.push(state.betState.currentBetUnits);
      state.currentBankroll -= wager;
    }

    function resetBet() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      if (confirm('Reset bet?')) {
        snapshots.push(JSON.parse(JSON.stringify(state)));
        state.betState = { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] };
        saveMemoryFast();
        updateMMDisplay();
      }
    }

    function getWager() {
      if (!state.baseUnit || state.stopProfitReached) return 0;
      return Math.min(state.betState.currentBetUnits * state.baseUnit, state.currentBankroll);
    }

    function updateDisplay() {
      updatePrediction();
      updateMMDisplay();
    }

    function updatePrediction() {
      const predDiv = document.getElementById('prediction');
      const shoeDiv = document.getElementById('shoeType');
      const historyDiv = document.getElementById('historyDisplay');

      historyDiv.innerHTML = '';
      state.history.forEach((item, index) => {
        const cell = document.createElement('div');
        cell.innerText = item;
        cell.className = item;
        if (state.outcomes[index]) {
          cell.classList.add(state.outcomes[index]);
          cell.setAttribute('data-outcome', state.outcomes[index]);
        }
        historyDiv.appendChild(cell);
      });

      const prediction = getCurrentPrediction();
      if (!prediction) {
        predDiv.innerText = 'Waiting for more hands...';
        shoeDiv.innerText = 'Detected Pattern: N/A';
        return;
      }

      const last5 = state.history.slice(-5);
      const countB = last5.filter(x => x === 'B').length;
      const countP = last5.filter(x => x === 'P').length;

      let explanation = '';
      if (last5.every((v, i, a) => i === 0 || v !== a[i - 1])) {
        explanation = 'Zigzag breaker detected.';
      } else if (last5.slice(-3).every(v => v === last5.at(-1))) {
        explanation = 'Streak detected.';
      } else if (countB === 4 || countP === 4) {
        explanation = 'Dominance detected in last 5.';
      } else {
        explanation = 'Underdog fallback.';
      }

      predDiv.innerText = `Prediction: ${prediction} (${explanation})`;

      let streaks = 0;
      for (let i = 1; i < state.history.length; i++) {
        if (state.history[i] === state.history[i - 1]) streaks++;
      }
      const chopScore = state.history.length > 1 ? state.history.length - 1 - streaks : 0;
      const chopRatio = state.history.length > 1 ? chopScore / (state.history.length - 1) : 0;

      let pattern = 'Balanced';
      if (chopRatio > 0.7) pattern = 'Chop';
      else if (chopRatio < 0.3) pattern = 'Streak';

      shoeDiv.innerText = `Detected Pattern: ${pattern}`;
    }

    function updateMMDisplay() {
      document.getElementById('streakInfo').innerText = state.stopProfitReached ? '' : 
        state.outcomes.slice(-3).every(v => v === 'L') ? `üßä Cold Streak - Losses: ${state.betState.previousLosses.length}` :
        state.outcomes.slice(-3).every(v => v === 'W') ? `üî• Hot Streak` : '';
      document.getElementById('currentWager').innerText = `üíµ Current Bet: ${getWager().toFixed(2)}`;
      document.getElementById('wins').innerText = state.wins;
      document.getElementById('losses').innerText = state.losses;
      document.getElementById('accuracy').innerText = state.wins + state.losses ? ((state.wins / (state.wins + state.losses)) * 100).toFixed(1) + '%' : '0%';
      const previousLosses = state.betState.previousLosses.length > 0 ? state.betState.previousLosses.join(', ') : 'None';
      const stopProfitDisplay = state.stopProfitValue > 0 ? 
        state.stopProfitType === 'percentage' ? `${state.stopProfitValue}% ($${state.stopProfitEffective.toFixed(2)})` : 
        `$${state.stopProfitValue.toFixed(2)}` : 'Not Set';
      document.getElementById('bankrollDisplay').innerHTML = state.startBankroll ? 
        `üíº Balance: ${state.currentBankroll.toFixed(2)} | Profit: ${(state.currentBankroll - state.startBankroll).toFixed(2)}<br>` +
        `Bet: $${(state.betState.currentBetUnits * state.baseUnit).toFixed(2)} (${state.betState.currentBetUnits} units)<br>` +
        `Losses: ${previousLosses}<br>` +
        `<span class="${state.betState.cycleProfit >= 1 ? 'cycle-reset' : ''}">Cycle: $${(state.betState.cycleProfit * state.baseUnit).toFixed(2)}</span><br>` +
        `Total: $${(state.betState.totalProfit * state.baseUnit).toFixed(2)}<br>` +
        `Stop: ${stopProfitDisplay} | ${state.stopProfitReached ? 'üö® Reached' : 'Active'}` : 
        'üíº Balance: - | Profit: -';
      document.getElementById('bankrollInput').value = state.startBankroll || '';
      document.getElementById('basebetInput').value = state.baseUnit || '';
      document.getElementById('stopProfitType').value = state.stopProfitType;
      document.getElementById('stopProfitInput').value = state.stopProfitValue || '';
    }

    function saveMemoryFast() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveMemory, 300);
    }

    async function saveMemory() {
      if (!currentUser || userDatabase[currentUser].isAdmin) return;
      try {
        userDatabase[currentUser].state = state;
        localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
      } catch (e) {
        alert('Error saving to cloud');
      }
    }

    async function loadMemory() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      if (!userDatabase[currentUser].isAdmin && (!userDatabase[currentUser].accessExpires || userDatabase[currentUser].accessExpires < Date.now())) {
        alert('Your subscription has expired. Contact an admin to renew.');
        logout();
        return;
      }
      try {
        state = userDatabase[currentUser].state;
        updateDisplay();
      } catch (e) {
        alert('Error loading from cloud');
      }
    }

    function toggleAdvanced() {
      const section = document.getElementById('advancedControls');
      const button = document.querySelector('.toggle-section');
      section.classList.toggle('show');
      button.innerText = section.classList.contains('show') ? 'Hide Advanced' : 'Show Advanced';
    }

    // Initialize
    window.onload = () => {
      document.getElementById('loginContainer').style.display = 'block';
      document.getElementById('appContainer').style.display = 'none';
      document.getElementById('adminContainer').style.display = 'none';
      auth.onAuthStateChanged(user => {
        if (user) {
          const username = user.email.split('@')[0];
          currentUser = username;
          if (!userDatabase[username]) {
            userDatabase[username] = {
              state: JSON.parse(JSON.stringify(state)),
              accessExpires: null,
              isAdmin: username === ADMIN_USERNAME
            };
            localStorage.setItem('bfcUsers', JSON.stringify(userDatabase));
          }
          if (userDatabase[username].isAdmin) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            updateAdminUserList();
          } else if (userDatabase[username].accessExpires > Date.now()) {
            state = userDatabase[username].state;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateDisplay();
            updateTimer();
            timerInterval = setInterval(updateTimer, 60000);
          } else {
            auth.signOut();
            document.getElementById('loginError').innerText = 'Your subscription has expired or is not set. Contact an admin.';
          }
        }
      });
    };
  </script>
</body>
</html>
