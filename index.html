<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BFC-VIP</title>
  <script type="module">
    // Firebase setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBs3LHGZA_8spAwQ5kgULiqcZmKqcIvZiI",
      authDomain: "bfc-vip.firebaseapp.com",
      projectId: "bfc-vip",
      storageBucket: "bfc-vip.appspot.com",
      messagingSenderId: "92211995630",
      appId: "1:92211995630:web:186a26085329fc607724ff",
      measurementId: "G-1EBPP36F59"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // Check auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const token = await user.getIdTokenResult();
        const isAdmin = token.claims.admin === true;

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        document.getElementById("adminTools").style.display = isAdmin ? "block" : "none";

        const docRef = doc(db, "subscriptions", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          const now = new Date();
          const expiry = new Date(data.expires);

          if (expiry > now) {
            document.getElementById("status").innerText = `âœ… Subscription active until ${expiry.toDateString()}`;
          } else {
            document.getElementById("status").innerText = "âŒ Subscription expired";
          }
        } else {
          document.getElementById("status").innerText = "âš ï¸ No subscription data found.";
        }
      } else {
        currentUser = null;
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("mainApp").style.display = "none";
      }
    });

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    };

    // Logout
    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth);
    };

    // Admin - create user
    document.getElementById("createUserBtn").onclick = async () => {
      const email = prompt("Enter new user's email:");
      const password = prompt("Enter password:");
      const expiryDays = parseInt(prompt("Enter subscription days (e.g. 30):"));

      if (!email || !password || isNaN(expiryDays)) return alert("Invalid input.");

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const newUid = cred.user.uid;
        const expiry = new Date();
        expiry.setDate(expiry.getDate() + expiryDays);

        await setDoc(doc(db, "subscriptions", newUid), {
          expires: expiry.toISOString()
        });

        alert("âœ… User created and subscription set.");
      } catch (err) {
        alert("âŒ Error: " + err.message);
      }
    };

    // Admin - view all users
    document.getElementById("viewUsersBtn").onclick = async () => {
      const querySnapshot = await getDocs(collection(db, "subscriptions"));
      let output = "ðŸ‘¥ Users:\n";
      querySnapshot.forEach(doc => {
        const data = doc.data();
        output += `â€¢ UID: ${doc.id}, Expiry: ${new Date(data.expires).toDateString()}\n`;
      });
      alert(output);
    };

    // Admin - update user expiry
    document.getElementById("updateUserBtn").onclick = async () => {
      const uid = prompt("Enter user UID:");
      const extraDays = parseInt(prompt("Add how many days?"));

      const ref = doc(db, "subscriptions", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("User not found");

      const data = snap.data();
      const newExpiry = new Date(data.expires);
      newExpiry.setDate(newExpiry.getDate() + extraDays);

      await updateDoc(ref, { expires: newExpiry.toISOString() });
      alert("âœ… Subscription updated");
    };

  </script>
</head>
<body>
  <h1>BFC-VIP</h1>

  <div id="loginSection">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
  </div>

  <div id="mainApp" style="display:none;">
    <h2>Welcome</h2>
    <p id="status"></p>
    <button id="logoutBtn">Logout</button>

    <div id="adminTools" style="display:none; margin-top:2rem;">
      <h3>ðŸ”§ Admin Tools</h3>
      <button id="createUserBtn">Create New User</button><br><br>
      <button id="viewUsersBtn">View All Users</button><br><br>
      <button id="updateUserBtn">Update User Expiry</button>
    </div>
  </div>
</body>
</html>
