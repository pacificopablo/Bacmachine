<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BFC VIP</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f4f6f8;
      color: #222;
    }
    h1 { text-align: center; font-size: 28px; color: #333; }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #fff;
      background: #6c757d;
    }
    button:hover { filter: brightness(85%); }
    .player { background-color: #2196F3; }
    .banker { background-color: #E91E63; }
    .tie { background-color: #FFC107; }
    .clear-all { background-color: #dc3545; }
    .prediction {
      font-weight: bold;
      font-size: 1.2rem;
      text-align: center;
      margin-top: 1rem;
    }
    .history {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .history div {
      width: 40px;
      height: 30px;
      margin: 3px;
      line-height: 30px;
      text-align: center;
      color: white;
      font-weight: bold;
      border-radius: 5px;
    }
    .P { background-color: #2196F3; }
    .B { background-color: #E91E63; }
    .T { background-color: #FFC107; }
    .stats {
      padding: 15px;
      text-align: center;
    }
    .section {
      text-align: center;
      margin: 12px 0;
      font-size: 18px;
      font-weight: 700;
    }
    .bet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    input[type=number], select, input[type=email], input[type=password] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 150px;
    }
    label { display: flex; align-items: center; gap: 6px; }
    .error { color: #dc3545; text-align: center; }
    .hidden { display: none; }
    @media (max-width: 500px) {
      .flex-row, .bet-controls { flex-direction: column; align-items: stretch; }
      input[type=number], select, input[type=email], input[type=password] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container hidden" id="appContainer">
    <h1>BFC VIP</h1>
    <div class="section" id="subscriptionStatus">Subscription: -</div>
    <div class="error" id="errorMessage"></div>
    <div class="flex-row">
      <button onclick="signOutUser()">Sign Out</button>
    </div>
    <div class="flex-row">
      <button class="player" onclick="recordResult('P')">Player</button>
      <button class="banker" onclick="recordResult('B')">Banker</button>
      <button class="tie" onclick="recordResult('T')">Tie</button>
      <button class="clear-all" onclick="clearAll()">Clear All</button>
    </div>
    <div class="prediction" id="prediction">Waiting for input...</div>
    <div class="stats">
      <div class="section" id="currentWager">üíµ Current Bet: 0</div>
      <div class="section" id="bankrollDisplay">üíº Balance: - | Profit: -</div>
      <div class="section">
        ‚úÖ <span id="wins">0</span> | ‚ùå <span id="losses">0</span>
      </div>
      <div class="bet-controls">
        <label><span>Bankroll</span><input type="number" id="bankrollInput" placeholder="Bankroll" min="0.01" step="0.01"></label>
        <label><span>Unit Value</span><input type="number" id="basebetInput" placeholder="Unit Value ($)" min="0.01" step="0.01"></label>
        <label>
          <select id="mmSystem">
            <option value="default">Default</option>
            <option value="plus1">Plus 1</option>
          </select>
        </label>
        <button onclick="setBankroll()">Set</button>
      </div>
    </div>
  </div>
  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        const { DateTime } = luxon;

        const firebaseConfig = {
          apiKey: "AIzaSyBs3LHGZA_8spAwQ5kgULiqcZmKqcIvZiI",
          authDomain: "bfc-vip.firebaseapp.com",
          projectId: "bfc-vip",
          storageBucket: "bfc-vip.appspot.com",
          messagingSenderId: "92211995630",
          appId: "1:92211995630:web:186a26085329fc607724ff",
          measurementId: "G-1EBPP36F59"
        };

        let app, auth, db;
        try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          console.log('Firebase initialized:', app.name);
        } catch (e) {
          console.error('Firebase init error:', e);
          document.body.innerHTML = `<div class="container"><h1>Error</h1><p>Firebase failed: ${e.message}</p></div>`;
          return;
        }

        let state = {
          history: [],
          wins: 0,
          losses: 0,
          baseUnit: 0,
          startBankroll: 0,
          currentBankroll: 0,
          betState: { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] },
          mmSystem: 'default'
        };
        let snapshots = [];
        let saveTimeout = null;

        function showMessage(message) {
          console.log('showMessage:', message);
          const errorMessage = document.getElementById('errorMessage') || document.getElementById('loginError');
          if (errorMessage) {
            errorMessage.innerText = message;
            setTimeout(() => { errorMessage.innerText = ''; }, 5000);
          }
        }

        function calculatePlusX(number) {
          console.log('calculatePlusX:', number);
          return number < 10 ? 1 : parseInt(number / 10);
        }

        function handleWin() {
          console.log('handleWin, state:', JSON.parse(JSON.stringify(state)));
          const wager = state.baseUnit * state.betState.currentBetUnits;
          const payout = state.history[state.history.length - 1] === 'B' ? wager * 0.95 : wager;
          state.currentBankroll += payout;
          if (state.mmSystem === 'default') {
            state.betState.totalProfit += state.betState.currentBetUnits;
            state.betState.cycleProfit += state.betState.currentBetUnits;
            if (state.betState.cycleProfit >= 1) {
              state.betState.currentBetUnits = 1;
              state.betState.cycleProfit = 0;
              state.betState.previousLosses = [];
            } else {
              state.betState.previousLosses.shift();
              state.betState.currentBetUnits = state.betState.previousLosses[0] ? state.betState.previousLosses[0] + calculatePlusX(state.betState.previousLosses[0]) : 1;
            }
          } else {
            state.betState.totalProfit += state.betState.currentBetUnits;
            state.betState.cycleProfit += state.betState.currentBetUnits;
            state.betState.previousLosses.shift();
            state.betState.currentBetUnits = state.betState.previousLosses[0] ? state.betState.previousLosses[0] + calculatePlusX(state.betState.previousLosses[0]) : 1;
            if (state.betState.cycleProfit >= 1) state.betState.cycleProfit = 0;
          }
          console.log('Win processed, currentBetUnits:', state.betState.currentBetUnits);
        }

        function handleLoss() {
          console.log('handleLoss, state:', JSON.parse(JSON.stringify(state)));
          const wager = state.baseUnit * state.betState.currentBetUnits;
          state.currentBankroll -= wager;
          state.betState.totalProfit -= state.betState.currentBetUnits;
          state.betState.cycleProfit -= state.betState.currentBetUnits;
          state.betState.previousLosses.push(state.betState.currentBetUnits);
          state.betState.currentBetUnits = state.betState.previousLosses[0] + calculatePlusX(state.betState.previousLosses[0]);
          console.log('Loss processed, currentBetUnits:', state.betState.currentBetUnits);
        }

        function recordResult(result) {
          console.log('recordResult:', result);
          if (!state.baseUnit || !state.startBankroll) {
            showMessage('Set bankroll/unit first');
            return;
          }
          snapshots.push(JSON.parse(JSON.stringify(state)));
          state.history.push(result);
          if (state.history.length < 5 || result === 'T') {
            showMessage(result === 'T' ? 'Tie recorded, no bet' : 'Waiting for 5 deals');
            updateUI();
            saveMemoryFast();
            return;
          }
          const prediction = selectPredictionAlgorithm();
          if (prediction.predict === 'None') {
            showMessage('No prediction yet');
            updateUI();
            saveMemoryFast();
            return;
          }
          if (result === prediction.predict) {
            state.wins++;
            handleWin();
          } else {
            state.losses++;
            handleLoss();
          }
          updateUI();
          saveMemoryFast();
        }

        function selectPredictionAlgorithm() {
          if (state.history.length < 5) {
            console.log('selectPredictionAlgorithm: Less than 5 deals');
            return { predict: 'None', confidence: 0 };
          }
          // Simplified prediction (Bayesian-like)
          const last4 = state.history.slice(-4).join('');
          const predict = Math.random() < 0.5 ? 'P' : 'B'; // Placeholder for actual logic
          console.log('Prediction:', predict);
          return { predict, confidence: 75 };
        }

        function updateUI() {
          console.log('updateUI, state:', JSON.parse(JSON.stringify(state)));
          document.getElementById('historyDisplay').innerHTML = state.history.slice(-10).map(r => `<div class="${r}">${r}</div>`).join('');
          document.getElementById('prediction').innerText = state.history.length < 5 ? 'Waiting for 5 deals...' : `Prediction: ${selectPredictionAlgorithm().predict}`;
          document.getElementById('currentWager').innerText = `üíµ Current Bet: ${(state.baseUnit * state.betState.currentBetUnits).toFixed(2)}`;
          document.getElementById('bankrollDisplay').innerText = 
            `üíº Balance: ${state.currentBankroll.toFixed(2)} | Profit: ${(state.betState.totalProfit * state.baseUnit).toFixed(2)}`;
          document.getElementById('wins').innerText = state.wins;
          document.getElementById('losses').innerText = state.losses;
        }

        function setBankroll() {
          console.log('setBankroll');
          const bankroll = parseFloat(document.getElementById('bankrollInput').value);
          const baseUnit = parseFloat(document.getElementById('basebetInput').value);
          const mmSystem = document.getElementById('mmSystem').value;
          if (!bankroll || !baseUnit || bankroll < baseUnit) {
            showMessage('Invalid bankroll or unit');
            return;
          }
          snapshots.push(JSON.parse(JSON.stringify(state)));
          state.startBankroll = bankroll;
          state.currentBankroll = bankroll;
          state.baseUnit = baseUnit;
          state.betState = { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] };
          state.mmSystem = mmSystem;
          updateUI();
          saveMemoryFast();
        }

        function clearAll() {
          console.log('clearAll');
          if (confirm('Clear all history?')) {
            snapshots.push(JSON.parse(JSON.stringify(state)));
            state.history = [];
            state.wins = 0;
            state.losses = 0;
            updateUI();
            saveMemoryFast();
          }
        }

        async function saveMemoryFast() {
          console.log('saveMemoryFast');
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(async () => {
            try {
              const user = auth.currentUser;
              if (user) {
                await setDoc(doc(db, 'users', user.uid), { state }, { merge: true });
                console.log('State saved');
              }
            } catch (e) {
              showMessage('Error saving: ' + e.message);
            }
          }, 300);
        }

        async function loadMemory() {
          console.log('loadMemory');
          try {
            const user = auth.currentUser;
            if (user) {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              if (userDoc.exists()) {
                const saved = userDoc.data().state || {};
                state = { ...state, ...saved };
                updateUI();
                console.log('State loaded:', state);
              }
            }
          } catch (e) {
            showMessage('Error loading: ' + e.message);
          }
        }

        async function signOutUser() {
          console.log('signOutUser');
          try {
            await setDoc(doc(db, 'users', auth.currentUser.uid), { isOnline: false }, { merge: true });
            await signOut(auth);
            document.getElementById('appContainer').classList.add('hidden');
            showLoginForm();
          } catch (e) {
            showMessage('Error signing out: ' + e.message);
          }
        }

        function showLoginForm() {
          console.log('showLoginForm');
          const existingLogin = document.getElementById('loginContainer');
          if (existingLogin) existingLogin.remove();
          const loginContainer = document.createElement('div');
          loginContainer.id = 'loginContainer';
          loginContainer.className = 'container';
          loginContainer.innerHTML = `
            <h1>BFC VIP Login</h1>
            <div class="flex-row">
              <label><span>Email</span><input type="email" id="loginEmail" placeholder="Email"></label>
              <label><span>Password</span><input type="password" id="loginPassword" placeholder="Password"></label>
              <button onclick="signInUser()">Login</button>
            </div>
            <div class="error" id="loginError"></div>
          `;
          document.body.prepend(loginContainer);
          console.log('Login form rendered');
        }

        async function signInUser() {
          console.log('signInUser');
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          const errorMessage = document.getElementById('loginError');
          if (!email || !password) {
            errorMessage.innerText = 'Enter email and password';
            return;
          }
          try {
            await signInWithEmailAndPassword(auth, email, password);
            document.getElementById('loginContainer').remove();
            document.getElementById('appContainer').classList.remove('hidden');
            await loadMemory();
          } catch (e) {
            errorMessage.innerText = 'Login failed: ' + e.message;
            console.error('signInUser error:', e);
          }
        }

        onAuthStateChanged(auth, async (user) => {
          console.log('onAuthStateChanged, user:', user ? user.email : null);
          try {
            const appContainer = document.getElementById('appContainer');
            if (user) {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              if (userDoc.exists()) {
                const subscriptionEnd = userDoc.data().subscriptionEnd;
                const now = DateTime.now().setZone('Asia/Manila').toMillis();
                if (!subscriptionEnd || subscriptionEnd < now) {
                  showMessage('Subscription expired');
                  await signOut(auth);
                  showLoginForm();
                  return;
                }
                document.getElementById('subscriptionStatus').innerText = 
                  `Subscription: Active until ${DateTime.fromMillis(subscriptionEnd, { zone: 'Asia/Manila' }).toLocaleString(DateTime.DATETIME_FULL)}`;
                await setDoc(doc(db, 'users', user.uid), { isOnline: true }, { merge: true });
                appContainer.classList.remove('hidden');
                await loadMemory();
              } else {
                showMessage('User data not found');
                await signOut(auth);
                showLoginForm();
              }
            } else {
              appContainer.classList.add('hidden');
              showLoginForm();
            }
          } catch (e) {
            console.error('onAuthStateChanged error:', e);
            document.body.innerHTML = `<div class="container"><h1>Error</h1><p>Auth failed: ${e.message}</p></div>`;
          }
        });

        // Bind functions to window
        window.recordResult = recordResult;
        window.clearAll = clearAll;
        window.setBankroll = setBankroll;
        window.signOutUser = signOutUser;
        window.signInUser = signInUser;

        console.log('BFC VIP initialized');
      } catch (e) {
        console.error('Script error:', e);
        document.body.innerHTML = `<div class="container"><h1>Error</h1><p>Script failed: ${e.message}</p></div>`;
      }
    });
  </script>
</body>
</html>
