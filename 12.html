<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BFC VIP</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    /* Existing styles from the main app */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f4f6f8;
      color: #222;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      color: #333;
    }
    h2 {
      font-size: 24px;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #fff;
      transition: background 0.3s;
    }
    button:hover {
      filter: brightness(85%);
    }
    .player { background-color: #2196F3; }
    .banker { background-color: #E91E63; }
    .tie { background-color: #FFC107; }
    .clear-all { background-color: #dc3545; }
    .set-bet, .reset-bet, .mm-action, .admin-action {
      background-color: #6c757d;
    }
    .fix-subscription { background-color: #28a745; }
    .toggle-section {
      background-color: #6c757d;
      padding: 8px;
      width: 100%;
      text-align: center;
    }
    .collapsible {
      display: none;
    }
    .collapsible.show {
      display: block;
    }
    .prediction {
      font-weight: bold;
      font-size: 1.2rem;
      text-align: center;
      margin-top: 1rem;
    }
    .shoe-type, .card-count {
      text-align: center;
      font-size: 1rem;
      margin-top: 0.5rem;
      color: #555;
    }
    .history {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .history div {
      width: 40px;
      height: 30px;
      margin: 3px;
      line-height: 30px;
      text-align: center;
      color: white;
      font-weight: bold;
      border-radius: 5px;
      position: relative;
    }
    .P { background-color: #2196F3; }
    .B { background-color: #E91E63; }
    .T { background-color: #FFC107; }
    .W::after, .L::after {
      content: attr(data-outcome);
      position: absolute;
      top: -10px;
      right: -5px;
      font-size: 12px;
      color: #fff;
      background: #28a745;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
    }
    .L::after {
      background: #dc3545;
    }
    .stats {
      padding: 15px;
      text-align: center;
    }
    .section {
      text-align: center;
      margin: 12px 0;
      font-size: 18px;
      font-weight: 700;
    }
    .bet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 90vw;
    }
    input[type=number], select, input[type=datetime-local], input[type=email], input[type=password], input[type=checkbox] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 150px;
    }
    label {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cycle-reset {
      color: #28a745;
      font-weight: 700;
    }
    .error {
      color: #dc3545;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .admin-panel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .admin-panel th, .admin-panel td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .admin-panel th {
      background-color: #f0f0f0;
    }
    .admin-panel button {
      background-color: #dc3545;
    }
    .online-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .online { background-color: #28a745; }
    .offline { background-color: #dc3545; }
    .algorithm-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    /* New styles from bank4.html */
    .grid { display: grid; gap: 14px; }
    .card {
      background: #171a2b;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 16px;
      color: #e6e9ff;
    }
    .row { display: grid; grid-template-columns: repeat(12,1fr); gap: 12px; }
    .row>.col-3 { grid-column: span 3; }
    .row>.col-4 { grid-column: span 4; }
    .row>.col-6 { grid-column: span 6; }
    .row>.col-8 { grid-column: span 8; }
    .row>.col-12 { grid-column: span 12; }
    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: #12152a;
      color: #e6e9ff;
    }
    .stat {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #12142a;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      align-items: flex-start;
      color: #e6e9ff;
    }
    .stat .big { font-size: 20px; font-weight: 700; }
    .muted { color: #8d95b5; }
    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .hr { height: 1px; background: rgba(255,255,255,.06); margin: 12px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.06); text-align: left; }
    th { color: #8d95b5; font-weight: 600; }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(255,255,255,.12); }
    .green { color: #86efac; }
    .red { color: #fecaca; }
    .center { display: flex; justify-content: center; align-items: center; }
    .small { font-size: 12px; }
    .btn {
      appearance: none;
      border: 0;
      background: #22284a;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .04s ease,opacity .15s;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn:hover { opacity: .95; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(120deg,#4f46e5,#06b6d4); }
    .btn.success { background: linear-gradient(120deg,#10b981,#22d3ee); }
    .btn.danger { background: linear-gradient(120deg,#ef4444,#f97316); }
    .btn.warn { background: linear-gradient(120deg,#f59e0b,#facc15); }

    /* Combined styles */
    .mm-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ccc;
    }
    .mm-tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #ddd;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .mm-tab.active {
      background: #4f46e5;
      color: white;
    }
    .mm-content {
      display: none;
    }
    .mm-content.active {
      display: block;
    }

    @media (max-width: 500px) {
      .flex-row { flex-direction: column; align-items: stretch; }
      .bet-controls { flex-direction: column; align-items: stretch; }
      .algorithm-checkboxes { flex-direction: column; align-items: center; }
      input[type=number], input[type=datetime-local], select, input[type=email], input[type=password] { width: 100%; }
      .row>.col-3, .row>.col-4, .row>.col-6 { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="container hidden" id="appContainer">
    <h1>BFC VIP</h1>
    <div class="section" id="subscriptionStatus">Subscription: -</div>
    <div class="error" id="errorMessage"></div>
    <div class="flex-row">
      <button onclick="signOutUser()" aria-label="Sign out">Sign Out</button>
    </div>

    <div class="mm-tabs">
      <div class="mm-tab active" onclick="switchMMTab('prediction')">Prediction System</div>
      <div class="mm-tab" onclick="switchMMTab('baccarat')">Baccarat MM Tracker</div>
    </div>

    <!-- Prediction System Tab -->
    <div id="predictionTab" class="mm-content active">
      <div class="flex-row">
        <button class="player" onclick="recordResult('P')" aria-label="Record Player result">Player</button>
        <button class="banker" onclick="recordResult('B')" aria-label="Record Banker result">Banker</button>
        <button class="tie" onclick="recordResult('T')" aria-label="Record Tie result">Tie</button>
        <button class="clear-all" onclick="clearAll()" aria-label="Clear all data">Clear All</button>
        <button class="undo" onclick="undo()" aria-label="Undo last action">Undo</button>
      </div>

      <div class="prediction" id="prediction">Waiting for input...</div>
      <div class="shoe-type admin-only" id="shoeType">Detected Pattern: N/A</div>
      <div class="card-count admin-only" id="cardCountDisplay">Card Count: N/A</div>
      <div class="section">Showing last 10 results</div>
      <div class="history" id="historyDisplay"></div>

      <div class="stats">
        <div class="section" id="currentWager">üíµ Current Bet: 0</div>
        <div class="section" id="bankrollDisplay">üíº Balance: - | Profit: -</div>
        <div class="section" id="streakInfo"></div>
        <div class="section">
          ‚úÖ <span id="wins">0</span> | ‚ùå <span id="losses">0</span> | üìä <span id="accuracy">0%</span>
        </div>
        <div class="bet-controls">
          <label><span>Bankroll</span><input type="number" id="bankrollInput" placeholder="Bankroll" min="0.01" step="0.01" aria-label="Set bankroll"></label>
          <label><span>Unit Value</span><input type="number" id="basebetInput" placeholder="Unit Value ($)" min="0.01" step="0.01" aria-label="Set base unit"></label>
          <label>
            <select id="stopProfitType" aria-label="Select stop profit type">
              <option value="currency">$</option>
              <option value="percentage">%</option>
            </select>
            <input type="number" id="stopProfitInput" placeholder="Stop Profit" min="0" step="0.01" aria-label="Set stop profit">
          </label>
          <label>
            <span>MM System</span>
            <select id="mmSystem" aria-label="Select money management system">
              <option value="default">Default</option>
              <option value="plus1">Plus 1</option>
            </select>
          </label>
          <button class="set-bet" onclick="setBankroll()" aria-label="Set bankroll and bet">Set</button>
        </div>
        <button class="toggle-section" onclick="toggleAdvanced()" aria-label="Toggle advanced controls">Show Advanced</button>
        <div class="flex-row collapsible" id="advancedControls">
          <button class="reset-bet" onclick="resetBet()" aria-label="Reset bet">Reset Bet</button>
          <button class="mm-action" onclick="saveMemory()" aria-label="Save state">üíæ</button>
          <button class="mm-action" onclick="loadMemory()" aria-label="Load state">üì•</button>
          <button class="mm-action" onclick="resetStats()" aria-label="Reset stats">üîÑ Reset Stats</button>
          <button class="mm-action" onclick="resetMemory()" aria-label="Reset memory">üß† Reset Memory</button>
        </div>
      </div>
    </div>

    <!-- Baccarat MM Tracker Tab -->
    <div id="baccaratTab" class="mm-content">
      <div class="grid">
        <h1>üéØ Baccarat Money Management Tracker</h1>
        <div class="card grid">
          <div class="row">
            <div class="col-3"><label>Initial Bankroll</label><input id="bankroll" type="number" min="0" step="0.01" /></div>
            <div class="col-3"><label>Base Bet (unit)</label><input id="baseBet" type="number" min="1" step="1" /></div>
            <div class="col-3"><label>Target Profit / Cycle</label><input id="targetProfit" type="number" min="1" step="1" /></div>
            <div class="col-3"><label>Increment per Achieved Cycle</label><input id="increment" type="number" min="0" step="1" /></div>
          </div>
          <div class="row">
            <div class="col-3"><label>Commission (Banker)</label><input id="commission" type="number" min="0" step="0.01" value="0.05" /></div>
            <div class="col-3"><label>Stop Loss</label><input id="stopLoss" type="number" min="0" step="0.01" /></div>
            <div class="col-3"><label>Enable Attack Mode</label><select id="attackMode"><option value="on">On</option><option value="off">Off</option></select></div>
            <div class="col-3 center"><button class="btn primary" id="saveCfg">üíæ Save / Apply</button></div>
          </div>
          <div class="row">
            <div class="col-12"><label>Table Notes</label><textarea id="tableNotes" placeholder="Enter notes about table patterns, trends, etc."></textarea></div>
          </div>
        </div>

        <div class="row">
          <div class="col-4"><div class="stat"><div class="muted">Current Bankroll</div><div class="big" id="statBankroll">0</div></div></div>
          <div class="col-4"><div class="stat"><div class="muted">Cycle Profit / Target</div><div class="big" id="statCycle">0 / 0</div><span class="badge" id="cycleBadge">Cycle #1</span></div></div>
          <div class="col-4"><div class="stat"><div class="muted">Mode</div><div class="big" id="statMode">Base</div><span class="badge" id="stepBadge">Step 1</span></div></div>
        </div>

        <div class="card grid">
          <div class="flex"><div class="badge">Suggested Next Bet</div><div class="big" id="nextBet" style="font-weight:800;font-size:24px">0</div><span class="muted small" id="nextBetNote">Base Mode</span></div>
          <div class="flex">
            <button class="btn success" id="btnWin">‚úÖ Record Win</button>
            <button class="btn danger" id="btnLoss">‚ùå Record Loss</button>
            <button class="btn warn" id="btnResetCycle">üîÅ Force Reset Cycle</button>
            <button class="btn" id="btnNewSession">üßπ New Session</button>
          </div>
        </div>

        <div class="card">
          <div class="flex" style="justify-content:space-between"><div class="badge">History</div><div class="muted small">Commission auto-applied on Banker wins.</div></div>
          <div class="hr"></div>
          <table><thead><tr><th>#</th><th>Mode</th><th>Step</th><th>Side</th><th>Bet</th><th>Result</th><th>P/L</th><th>Cycle Profit</th><th>Bankroll</th><th>Note</th></tr></thead><tbody id="history"></tbody></table>
        </div>
      </div>
    </div>

    <!-- Admin Panel (same as before) -->
    <div class="admin-panel hidden" id="adminPanel">
      <h2>Admin Panel</h2>
      <div class="section">
        <h3>Create User</h3>
        <div class="flex-row">
          <label><span>Email</span><input type="email" id="newUserEmail" placeholder="Email" aria-label="New user email"></label>
          <label><span>Password</span><input type="password" id="newUserPassword" placeholder="Password" aria-label="New user password"></label>
          <label><span>Admin</span><input type="checkbox" id="newUserIsAdmin" aria-label="New user admin status"></label>
          <button class="admin-action" onclick="createUser()">Create User</button>
        </div>
      </div>
      <div class="section">
        <h3>Manage Users</h3>
        <table id="userTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Subscription End (PST)</th>
              <th>Admin</th>
              <th>Add Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
      <div class="section">
        <h3>Add Subscription Time</h3>
        <div class="flex-row">
          <label><span>User Email</span><input type="email" id="extendUserEmail" placeholder="User Email" aria-label="User email to extend subscription"></label>
          <label>
            <select id="extendTimeUnit" aria-label="Select time unit">
              <option value="hours">Hours</option>
              <option value="days">Days</option>
              <option value="test">24-Hour Test</option>
            </select>
          </label>
          <label><span>Amount</span><input type="number" id="extendTimeAmount" placeholder="Amount" min="1" step="1" aria-label="Amount of time to add"></label>
          <button class="admin-action" onclick="extendSubscription()">Add Time</button>
        </div>
      </div>
      <div class="section">
        <h3>Algorithm Selection</h3>
        <div class="flex-row algorithm-checkboxes">
          <label><input type="checkbox" id="bayesianCheckbox" onchange="setAlgorithms()" aria-label="Use Bayesian algorithm">Bayesian</label>
          <label><input type="checkbox" id="chatgptCheckbox" onchange="setAlgorithms()" aria-label="Use ChatGPT algorithm">ChatGPT</label>
          <label><input type="checkbox" id="grokCheckbox" onchange="setAlgorithms()" aria-label="Use Grok algorithm">Grok</label>
          <label><input type="checkbox" id="neuralnetCheckbox" onchange="setAlgorithms()" aria-label="Use Neural Network algorithm">Neural Network</label>
        </div>
      </div>
      <div class="section">
        <h3>Online Users</h3>
        <table id="onlineUsersTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="onlineUsersTableBody"></tbody>
        </table>
      </div>
      <div class="section">
        <h3>Non-Admin Algorithm Accuracy</h3>
        <table id="algorithmAccuracyTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Bayesian</th>
              <th>ChatGPT</th>
              <th>Grok</th>
              <th>Neural Net</th>
            </tr>
          </thead>
          <tbody id="algorithmAccuracyTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js';
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const { DateTime } = luxon;

    const firebaseConfig = {
      apiKey: "AIzaSyBs3LHGZA_8spAwQ5kgULiqcZmKqcIvZiI",
      authDomain: "bfc-vip.firebaseapp.com",
      projectId: "bfc-vip",
      storageBucket: "bfc-vip.appspot.com",
      messagingSenderId: "92211995630",
      appId: "1:92211995630:web:186a26085329fc607724ff",
      measurementId: "G-1EBPP36F59"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);

    let globalSelectedAlgorithms = ['bayesian']; // Default to Bayesian
    let isAdmin = false;
    let onlineUsersUnsubscribe = null;
    let accuracyUnsubscribe = null;
    let globalSettingsUnsubscribe = null;

    // Baccarat MM Tracker State and Functions
    let baccaratState = { 
      bankroll: 0, 
      baseBet: 1, 
      targetProfit: 3, 
      increment: 0, 
      commission: 0.05, 
      stopLoss: 0, 
      attackMode: 'on', 
      tableNotes: '', 
      cycle: 1, 
      cycleProfit: 0, 
      mode: 'Base', 
      baseLossStreak: 0, 
      recoverySteps: [2,3,4,6], 
      recoveryIndex: 0, 
      attackSteps: [1,2,4], 
      attackIndex: 0, 
      attackActive: false, 
      history: [], 
      hand: 0 
    };

    function syncBaccaratInputs() { 
      document.getElementById('bankroll').value = baccaratState.bankroll; 
      document.getElementById('baseBet').value = baccaratState.baseBet; 
      document.getElementById('targetProfit').value = baccaratState.targetProfit; 
      document.getElementById('increment').value = baccaratState.increment; 
      document.getElementById('commission').value = baccaratState.commission; 
      document.getElementById('stopLoss').value = baccaratState.stopLoss; 
      document.getElementById('attackMode').value = baccaratState.attackMode; 
      document.getElementById('tableNotes').value = baccaratState.tableNotes; 
    }

    function saveBaccaratCfg() { 
      baccaratState.bankroll = num(document.getElementById('bankroll').value, baccaratState.bankroll); 
      baccaratState.baseBet = int(document.getElementById('baseBet').value, baccaratState.baseBet); 
      baccaratState.targetProfit = int(document.getElementById('targetProfit').value, baccaratState.targetProfit); 
      baccaratState.increment = int(document.getElementById('increment').value, baccaratState.increment); 
      baccaratState.commission = num(document.getElementById('commission').value, baccaratState.commission); 
      baccaratState.stopLoss = num(document.getElementById('stopLoss').value, baccaratState.stopLoss); 
      baccaratState.attackMode = document.getElementById('attackMode').value; 
      baccaratState.tableNotes = document.getElementById('tableNotes').value; 
      persistBaccaratState(); 
      renderBaccarat(); 
    }

    function num(v,d){v=parseFloat(v);return isFinite(v)?v:d} 
    function int(v,d){v=parseInt(v,10);return isFinite(v)?v:d}

    function nextBetAmount(){ 
      if(baccaratState.mode==='Base') return baccaratState.baseBet; 
      if(baccaratState.mode==='Recovery') return baccaratState.baseBet*baccaratState.recoverySteps[baccaratState.recoveryIndex]; 
      if(baccaratState.mode==='Attack') return baccaratState.baseBet*baccaratState.attackSteps[baccaratState.attackIndex]; 
      return baccaratState.baseBet; 
    }

    function stepBadges(){ 
      if(baccaratState.mode==='Base') return{mode:'Base',step:`Step ${Math.min(baccaratState.baseLossStreak+1,3)}`,note:'Base Mode'}; 
      if(baccaratState.mode==='Recovery') return{mode:'Recovery',step:`Step ${baccaratState.recoveryIndex+1}/${baccaratState.recoverySteps.length}`,note:'Mild progression 2-3-4-6'}; 
      if(baccaratState.mode==='Attack') return{mode:'Attack',step:`Step ${baccaratState.attackIndex+1}/${baccaratState.attackSteps.length}`,note:'Mini-parlay 1‚Üí2‚Üí4'}; 
      return{mode:'Base',step:'Step 1',note:''}; 
    }

    function fmt(n){return (Math.round((typeof n==='number'?n:parseFloat(n)||0)*100)/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

    function persistBaccaratState(){ 
      const user = auth.currentUser;
      if (user) {
        setDoc(doc(db, 'users', user.uid), { baccaratState }, { merge: true });
      }
    }

    function resetBaccaratCycle(manual=false){ 
      baccaratState.cycleProfit=0; 
      baccaratState.mode='Base'; 
      baccaratState.baseLossStreak=0; 
      baccaratState.recoveryIndex=0; 
      baccaratState.attackIndex=0; 
      baccaratState.attackActive=false; 
      if(!manual){baccaratState.cycle+=1;} 
      persistBaccaratState(); 
      renderBaccarat(); 
    }

    function newBaccaratSession(){ 
      const keep={
        bankroll:num(document.getElementById('bankroll').value,baccaratState.bankroll),
        baseBet:int(document.getElementById('baseBet').value,baccaratState.baseBet),
        targetProfit:int(document.getElementById('targetProfit').value,baccaratState.targetProfit),
        increment:int(document.getElementById('increment').value,baccaratState.increment),
        commission:num(document.getElementById('commission').value,baccaratState.commission),
        stopLoss:num(document.getElementById('stopLoss').value,baccaratState.stopLoss),
        attackMode:document.getElementById('attackMode').value,
        tableNotes:document.getElementById('tableNotes').value
      }; 
      baccaratState=Object.assign({
        cycle:1,cycleProfit:0,mode:'Base',baseLossStreak:0,recoverySteps:[2,3,4,6],recoveryIndex:0,
        attackSteps:[1,2,4],attackIndex:0,attackActive:false,history:[],hand:0
      },keep); 
      persistBaccaratState(); 
      syncBaccaratInputs(); 
      renderBaccarat(); 
    }

    function autoTransitionsOnResult(win){ 
      if(baccaratState.mode==='Base'){ 
        if(win){baccaratState.baseLossStreak=0;} 
        else {baccaratState.baseLossStreak+=1;if(baccaratState.baseLossStreak>=2){baccaratState.mode='Recovery';baccaratState.recoveryIndex=0;}} 
      } else if(baccaratState.mode==='Recovery'){ 
        if(win){ 
          if(baccaratState.attackMode==='on'){baccaratState.mode='Attack';baccaratState.attackIndex=0;baccaratState.attackActive=true;} 
          else {baccaratState.mode='Base';baccaratState.baseLossStreak=0;baccaratState.recoveryIndex=0;} 
        } else { 
          if(baccaratState.recoveryIndex<baccaratState.recoverySteps.length-1){baccaratState.recoveryIndex+=1;} 
          else {baccaratState.mode='Base';baccaratState.baseLossStreak=0;baccaratState.recoveryIndex=0;} 
        } 
      } else if(baccaratState.mode==='Attack'){ 
        if(win){ 
          if(baccaratState.attackIndex<baccaratState.attackSteps.length-1){baccaratState.attackIndex+=1;} 
          else {baccaratState.mode='Base';baccaratState.baseLossStreak=0;baccaratState.attackIndex=0;baccaratState.attackActive=false;} 
        } else { 
          baccaratState.mode='Base';baccaratState.baseLossStreak=0;baccaratState.attackIndex=0;baccaratState.attackActive=false; 
        } 
      } 
    }

    function applyBaccaratResult(res){ 
      if(baccaratState.stopLoss>0 && baccaratState.bankroll <= baccaratState.bankroll-baccaratState.stopLoss){ 
        alert('Stop Loss reached. No more bets this session.'); 
        return; 
      } 
      const bet=nextBetAmount(); 
      const side='banker'; 
      let pl=0; 
      if(res==='W'){ 
        pl=side==='banker'?bet*(1-baccaratState.commission):bet; 
      } else { 
        pl=-bet; 
      } 
      baccaratState.bankroll+=pl; 
      baccaratState.cycleProfit+=pl; 
      const before=stepBadges(); 
      autoTransitionsOnResult(res==='W'); 
      let note=''; 
      if(baccaratState.cycleProfit>=baccaratState.targetProfit){ 
        note=`Cycle target reached (+${fmt(baccaratState.cycleProfit)} ‚â• ${fmt(baccaratState.targetProfit)}). Target +${baccaratState.increment}.`; 
        baccaratState.targetProfit+=baccaratState.increment; 
        resetBaccaratCycle(false); 
      } 
      baccaratState.hand+=1; 
      baccaratState.history.unshift({
        hand:baccaratState.hand,
        mode:before.mode,
        step:before.step,
        side:side,
        bet:bet,
        result:res,
        pl:pl,
        cycleProfit:baccaratState.cycleProfit,
        bankroll:baccaratState.bankroll,
        note:note||before.note
      }); 
      persistBaccaratState(); 
      renderBaccarat(); 
    }

    function renderBaccarat(){ 
      document.getElementById('nextBet').textContent=nextBetAmount(); 
      const b=stepBadges(); 
      document.getElementById('nextBetNote').textContent=b.note; 
      document.getElementById('statBankroll').textContent=fmt(baccaratState.bankroll); 
      document.getElementById('statCycle').textContent=`${fmt(baccaratState.cycleProfit)} / ${fmt(baccaratState.targetProfit)}`; 
      document.getElementById('cycleBadge').textContent=`Cycle #${baccaratState.cycle}`; 
      document.getElementById('statMode').textContent=b.mode; 
      document.getElementById('stepBadge').textContent=b.step; 
      document.getElementById('history').innerHTML=baccaratState.history.map(r=>
        `<tr>
          <td>${r.hand}</td>
          <td><span class="pill">${r.mode}</span></td>
          <td>${r.step}</td>
          <td>${r.side}</td>
          <td>${fmt(r.bet)}</td>
          <td>${r.result==='W'?'<span class="green">Win</span>':'<span class="red">Loss</span>'}</td>
          <td>${r.pl>=0?'<span class="green">'+fmt(r.pl)+'</span>':'<span class="red">'+fmt(r.pl)+'</span>'}</td>
          <td>${fmt(r.cycleProfit)}</td>
          <td>${fmt(r.bankroll)}</td>
          <td class="small muted">${r.note||''}</td>
        </tr>`
      ).join(''); 
    }

    function switchMMTab(tabName) {
      document.querySelectorAll('.mm-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.mm-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.mm-tab[onclick="switchMMTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    // Initialize Baccarat MM Tracker
    document.getElementById('saveCfg').addEventListener('click', saveBaccaratCfg); 
    document.getElementById('btnWin').addEventListener('click', ()=>applyBaccaratResult('W')); 
    document.getElementById('btnLoss').addEventListener('click', ()=>applyBaccaratResult('L')); 
    document.getElementById('btnResetCycle').addEventListener('click', ()=>{resetBaccaratCycle(true);renderBaccarat();}); 
    document.getElementById('btnNewSession').addEventListener('click', ()=>{if(confirm('Start a new session? History will clear.'))newBaccaratSession();});

    // Rest of your existing Firebase and prediction system code remains the same...
    // (All the existing code for the prediction system, admin panel, etc.)
    // ...

    onAuthStateChanged(auth, async user => {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.innerText = '';
      if (user) {
        try {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.isAdmin || false;
            const subscriptionEnd = Number.isInteger(userData.subscriptionEnd) ? userData.subscriptionEnd : null;
            const currentTime = DateTime.now().setZone('Asia/Manila').toMillis();
            
            if (subscriptionEnd && currentTime < subscriptionEnd) {
              await setDoc(doc(db, 'users', user.uid), { isOnline: true }, { merge: true });
              document.getElementById('appContainer').classList.remove('hidden');
              document.getElementById('subscriptionStatus').innerText = `Subscription: Active until ${DateTime.fromMillis(subscriptionEnd, { zone: 'Asia/Manila' }).toLocaleString(DateTime.DATETIME_FULL)}`;
              document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
              document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
              
              // Load Baccarat MM state if it exists
              if (userData.baccaratState) {
                baccaratState = userData.baccaratState;
                syncBaccaratInputs();
                renderBaccarat();
              }
              
              if (isAdmin) {
                loadUsers();
                onlineUsersUnsubscribe = loadOnlineUsers();
                accuracyUnsubscribe = loadAlgorithmAccuracy();
                const selectedAlgorithms = userData.state?.selectedAlgorithms || globalSelectedAlgorithms;
                document.getElementById('bayesianCheckbox').checked = selectedAlgorithms.includes('bayesian');
                document.getElementById('chatgptCheckbox').checked = selectedAlgorithms.includes('chatgpt');
                document.getElementById('grokCheckbox').checked = selectedAlgorithms.includes('grok');
                document.getElementById('neuralnetCheckbox').checked = selectedAlgorithms.includes('neuralnet');
              }
              globalSettingsUnsubscribe = loadGlobalSettings();
              loadMemory();
            } else {
              await setDoc(doc(db, 'users', user.uid), { isOnline: false }, { merge: true });
              showMessage('Your subscription has expired or is invalid. Contact admin to renew.');
              signOut(auth);
            }
          } else {
            showMessage('User data not found. Contact admin.');
            signOut(auth);
          }
        } catch (error) {
          console.error('Error:', error);
          showMessage('Error checking subscription: ' + error.message);
          await setDoc(doc(db, 'users', user.uid), { isOnline: false }, { merge: true });
          signOut(auth);
        }
      } else {
        if (onlineUsersUnsubscribe) {
          onlineUsersUnsubscribe();
          onlineUsersUnsubscribe = null;
        }
        if (accuracyUnsubscribe) {
          accuracyUnsubscribe();
          accuracyUnsubscribe = null;
        }
        if (globalSettingsUnsubscribe) {
          globalSettingsUnsubscribe();
          globalSettingsUnsubscribe = null;
        }
        window.location.href = 'login.html';
      }
    });

    // Add the Baccarat MM functions to the window object
    window.switchMMTab = switchMMTab;
    window.saveBaccaratCfg = saveBaccaratCfg;
    window.applyBaccaratResult = applyBaccaratResult;
    window.resetBaccaratCycle = resetBaccaratCycle;
    window.newBaccaratSession = newBaccaratSession;
  </script>
</body>
</html>
