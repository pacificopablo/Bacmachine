<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BFC VIP</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    /* Previous CSS remains unchanged */
    .settings-panel {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #dee2e6;
    }
    .settings-label {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .settings-label input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <!-- Previous HTML content remains the same until admin panel -->

    <div class="admin-panel hidden" id="adminPanel">
      <!-- Previous admin panel content remains the same -->

      <!-- Add this new section -->
      <div class="section">
        <h3>Algorithm Configuration</h3>
        <div class="settings-panel">
          <div class="settings-label">
            <input type="checkbox" id="useNeuralNet" checked>
            <span>Neural Network (Primary)</span>
          </div>
          <div class="settings-label">
            <input type="checkbox" id="useBayesian" checked>
            <span>Bayesian Probability</span>
          </div>
          <div class="settings-label">
            <input type="checkbox" id="useChatGPT" checked>
            <span>ChatGPT-style</span>
          </div>
          <div class="settings-label">
            <input type="checkbox" id="useGrok" checked>
            <span>Grok Algorithm</span>
          </div>
          <div style="margin-top: 15px;">
            <button class="admin-action" onclick="saveAlgorithmSettings()">Save Configuration</button>
            <button class="mm-action" onclick="resetAlgorithmSettings()" style="margin-left: 10px;">Reset Defaults</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add this section for regular users -->
    <div class="section collapsible" id="userSettingsPanel">
      <h3>Algorithm Preferences</h3>
      <div class="settings-panel">
        <div class="settings-label">
          <input type="checkbox" id="userUseNeuralNet">
          <span>Use Neural Network</span>
        </div>
        <div class="settings-label">
          <input type="checkbox" id="userUseBayesian">
          <span>Use Bayesian</span>
        </div>
        <div class="settings-label">
          <input type="checkbox" id="userUseChatGPT">
          <span>Use ChatGPT-style</span>
        </div>
        <div class="settings-label">
          <input type="checkbox" id="userUseGrok">
          <span>Use Grok Algorithm</span>
        </div>
        <div style="margin-top: 15px;">
          <button class="mm-action" onclick="saveUserAlgorithmSettings()">Save Preferences</button>
        </div>
      </div>
    </div>

    <!-- Add toggle button for user settings -->
    <button class="toggle-section" onclick="toggleUserSettings()">Algorithm Settings</button>

    <!-- Rest of your HTML remains the same -->
  </div>

  <script type="module">
    // Previous imports remain the same

    const { DateTime } = luxon;

    const firebaseConfig = {
      apiKey: "AIzaSyBs3LHGZA_8spAwQ5kgULiqcZmKqcIvZiI",
      authDomain: "bfc-vip.firebaseapp.com",
      projectId: "bfc-vip",
      storageBucket: "bfc-vip.appspot.com",
      messagingSenderId: "92211995630",
      appId: "1:92211995630:web:186a26085329fc607724ff",
      measurementId: "G-1EBPP36F59"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);

    let state = {
      // Previous state properties remain
      algorithmSettings: {
        global: {
          neuralNet: true,
          bayesian: true,
          chatGPT: true,
          grok: true
        },
        userOverrides: {} // { userId: { neuralNet: boolean, ... } }
      }
    };

    // New Algorithm Settings Functions
    function toggleUserSettings() {
      const section = document.getElementById('userSettingsPanel');
      const button = document.querySelector('.toggle-section[onclick="toggleUserSettings()"]');
      section.classList.toggle('show');
      button.innerText = section.classList.contains('show') ? 'Hide Settings' : 'Algorithm Settings';
      loadUserAlgorithmSettings();
    }

    function loadAlgorithmSettings() {
      document.getElementById('useNeuralNet').checked = state.algorithmSettings.global.neuralNet;
      document.getElementById('useBayesian').checked = state.algorithmSettings.global.bayesian;
      document.getElementById('useChatGPT').checked = state.algorithmSettings.global.chatGPT;
      document.getElementById('useGrok').checked = state.algorithmSettings.global.grok;
    }

    function loadUserAlgorithmSettings() {
      const user = auth.currentUser;
      if (!user) return;
      
      const userSettings = state.algorithmSettings.userOverrides[user.uid] || {};
      
      document.getElementById('userUseNeuralNet').checked = 
        userSettings.neuralNet !== undefined ? userSettings.neuralNet : state.algorithmSettings.global.neuralNet;
      document.getElementById('userUseBayesian').checked = 
        userSettings.bayesian !== undefined ? userSettings.bayesian : state.algorithmSettings.global.bayesian;
      document.getElementById('userUseChatGPT').checked = 
        userSettings.chatGPT !== undefined ? userSettings.chatGPT : state.algorithmSettings.global.chatGPT;
      document.getElementById('userUseGrok').checked = 
        userSettings.grok !== undefined ? userSettings.grok : state.algorithmSettings.global.grok;
    }

    function saveAlgorithmSettings() {
      if (!isAdmin) {
        showMessage('Only admins can modify global settings');
        return;
      }
      
      state.algorithmSettings.global = {
        neuralNet: document.getElementById('useNeuralNet').checked,
        bayesian: document.getElementById('useBayesian').checked,
        chatGPT: document.getElementById('useChatGPT').checked,
        grok: document.getElementById('useGrok').checked
      };
      
      saveMemoryFast();
      showMessage('Global algorithm settings saved!');
    }

    function saveUserAlgorithmSettings() {
      const user = auth.currentUser;
      if (!user) return;
      
      state.algorithmSettings.userOverrides[user.uid] = {
        neuralNet: document.getElementById('userUseNeuralNet').checked,
        bayesian: document.getElementById('userUseBayesian').checked,
        chatGPT: document.getElementById('userUseChatGPT').checked,
        grok: document.getElementById('userUseGrok').checked
      };
      
      saveMemoryFast();
      showMessage('Your preferences saved!');
    }

    function resetAlgorithmSettings() {
      if (!isAdmin) {
        showMessage('Only admins can reset global settings');
        return;
      }
      
      state.algorithmSettings.global = {
        neuralNet: true,
        bayesian: true,
        chatGPT: true,
        grok: true
      };
      loadAlgorithmSettings();
      showMessage('Reset to default algorithm settings');
    }

    // Updated selectPredictionAlgorithm
    function selectPredictionAlgorithm() {
      const user = auth.currentUser;
      let settings;
      
      if (user && state.algorithmSettings.userOverrides[user.uid]) {
        settings = state.algorithmSettings.userOverrides[user.uid];
      } else {
        settings = state.algorithmSettings.global;
      }
      
      const recentAccuracy = calculateRecentAccuracy();
      
      // Try neural network first if enabled and has enough data
      if (settings.neuralNet && state.history.length >= 10) {
        const neuralPrediction = neuralNetPrediction();
        if (neuralPrediction.confidence >= getDynamicConfidenceThreshold()) {
          return neuralPrediction;
        }
      }
      
      // Collect enabled algorithms
      const enabledAlgorithms = [];
      if (settings.bayesian) enabledAlgorithms.push(bayesianPrediction);
      if (settings.chatGPT) enabledAlgorithms.push(chatGPTPrediction);
      if (settings.grok) enabledAlgorithms.push(grokPrediction);
      
      // If no algorithms enabled, return neutral prediction
      if (enabledAlgorithms.length === 0) {
        return { predict: null, confidence: 0, score: 0 };
      }
      
      // Get predictions from all enabled algorithms
      const predictions = enabledAlgorithms.map(algo => algo());
      
      // Return the prediction with highest confidence
      return predictions.reduce((best, current) => 
        current.confidence > best.confidence ? current : best
      );
    }

    // Updated loadMemory
    async function loadMemory() {
      try {
        const user = auth.currentUser;
        if (user) {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (userDoc.exists()) {
            const saved = userDoc.data().state || {};
            // ... existing state loading ...
            
            // Load algorithm settings
            state.algorithmSettings = saved.algorithmSettings || {
              global: {
                neuralNet: true,
                bayesian: true,
                chatGPT: true,
                grok: true
              },
              userOverrides: {}
            };
            
            if (isAdmin) {
              loadAlgorithmSettings();
            }
            loadUserAlgorithmSettings();
          }
        }
      } catch (e) {
        showMessage('Error loading: ' + e.message);
      }
    }

    // Add to window exports
    window.toggleUserSettings = toggleUserSettings;
    window.saveAlgorithmSettings = saveAlgorithmSettings;
    window.saveUserAlgorithmSettings = saveUserAlgorithmSettings;
    window.resetAlgorithmSettings = resetAlgorithmSettings;

    // Rest of your existing JavaScript remains unchanged
  </script>
</body>
</html>
