<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Previous head content remains the same -->
  <style>
    /* Previous styles remain the same */
    
    /* Additional styles for Baccarat MM system */
    .baccarat-mm-controls {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #171a2b;
      border-radius: 12px;
      color: #e6e9ff;
    }
    
    .baccarat-mm-controls.active {
      display: block;
    }
    
    .baccarat-row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .baccarat-col-3 {
      grid-column: span 3;
    }
    
    .baccarat-col-4 {
      grid-column: span 4;
    }
    
    .baccarat-col-6 {
      grid-column: span 6;
    }
    
    .baccarat-col-12 {
      grid-column: span 12;
    }
    
    @media (max-width: 768px) {
      .baccarat-col-3, .baccarat-col-4, .baccarat-col-6 {
        grid-column: span 12;
      }
    }
  </style>
</head>
<body>
  <div class="container hidden" id="appContainer">
    <!-- Previous content remains the same until the bet-controls section -->
    
    <div class="bet-controls">
      <label><span>Bankroll</span><input type="number" id="bankrollInput" placeholder="Bankroll" min="0.01" step="0.01" aria-label="Set bankroll"></label>
      <label><span>Unit Value</span><input type="number" id="basebetInput" placeholder="Unit Value ($)" min="0.01" step="0.01" aria-label="Set base unit"></label>
      <label>
        <select id="stopProfitType" aria-label="Select stop profit type">
          <option value="currency">$</option>
          <option value="percentage">%</option>
        </select>
        <input type="number" id="stopProfitInput" placeholder="Stop Profit" min="0" step="0.01" aria-label="Set stop profit">
      </label>
      <label>
        <span>MM System</span>
        <select id="mmSystem" aria-label="Select money management system" onchange="toggleMMSystem()">
          <option value="default">Default</option>
          <option value="plus1">Plus 1</option>
          <option value="baccarat">Baccarat MM</option>
        </select>
      </label>
      <button class="set-bet" onclick="setBankroll()" aria-label="Set bankroll and bet">Set</button>
    </div>
    
    <!-- Baccarat MM Controls (hidden by default) -->
    <div id="baccaratMMControls" class="baccarat-mm-controls">
      <div class="baccarat-row">
        <div class="baccarat-col-3"><label>Target Profit / Cycle</label><input id="targetProfit" type="number" min="1" step="1" value="3" /></div>
        <div class="baccarat-col-3"><label>Increment per Cycle</label><input id="increment" type="number" min="0" step="1" value="0" /></div>
        <div class="baccarat-col-3"><label>Commission (Banker)</label><input id="commission" type="number" min="0" step="0.01" value="0.05" /></div>
        <div class="baccarat-col-3"><label>Stop Loss</label><input id="stopLoss" type="number" min="0" step="0.01" /></div>
      </div>
      <div class="baccarat-row">
        <div class="baccarat-col-4"><label>Enable Attack Mode</label><select id="attackMode"><option value="on">On</option><option value="off">Off</option></select></div>
        <div class="baccarat-col-8"><label>Table Notes</label><textarea id="tableNotes" placeholder="Enter notes about table patterns, trends, etc."></textarea></div>
      </div>
      <div class="baccarat-row">
        <div class="baccarat-col-4">
          <button class="btn success" onclick="recordBaccaratResult('W')">‚úÖ Record Win</button>
        </div>
        <div class="baccarat-col-4">
          <button class="btn danger" onclick="recordBaccaratResult('L')">‚ùå Record Loss</button>
        </div>
        <div class="baccarat-col-4">
          <button class="btn warn" onclick="resetBaccaratCycle()">üîÅ Reset Cycle</button>
        </div>
      </div>
      <div class="baccarat-row">
        <div class="baccarat-col-6">
          <div class="stat"><div class="muted">Cycle Profit / Target</div><div class="big" id="statCycle">0 / 0</div></div>
        </div>
        <div class="baccarat-col-6">
          <div class="stat"><div class="muted">Mode</div><div class="big" id="statMode">Base</div></div>
        </div>
      </div>
      <div class="baccarat-row">
        <div class="baccarat-col-12">
          <div class="stat"><div class="muted">Suggested Next Bet</div><div class="big" id="nextBet">0</div></div>
        </div>
      </div>
    </div>
    
    <!-- Rest of your existing content remains the same -->
    
  </div>

  <script type="module">
    // Previous imports and Firebase config remain the same
    
    // Add Baccarat MM state
    let baccaratMMState = {
      targetProfit: 3,
      increment: 0,
      commission: 0.05,
      stopLoss: 0,
      attackMode: 'on',
      tableNotes: '',
      cycle: 1,
      cycleProfit: 0,
      mode: 'Base',
      baseLossStreak: 0,
      recoverySteps: [2,3,4,6],
      recoveryIndex: 0,
      attackSteps: [1,2,4],
      attackIndex: 0,
      attackActive: false
    };
    
    // Helper functions
    function num(v,d){v=parseFloat(v);return isFinite(v)?v:d}
    function int(v,d){v=parseInt(v,10);return isFinite(v)?v:d}
    function fmt(n){return (Math.round((typeof n==='number'?n:parseFloat(n)||0)*100)/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
    
    // Toggle MM system visibility
    function toggleMMSystem() {
      const mmSystem = document.getElementById('mmSystem').value;
      const baccaratControls = document.getElementById('baccaratMMControls');
      
      if (mmSystem === 'baccarat') {
        baccaratControls.classList.add('active');
        loadBaccaratState();
      } else {
        baccaratControls.classList.remove('active');
      }
    }
    
    // Load Baccarat MM state from Firestore
    async function loadBaccaratState() {
      try {
        const user = auth.currentUser;
        if (user) {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (userDoc.exists() && userDoc.data().baccaratMMState) {
            baccaratMMState = userDoc.data().baccaratMMState;
            updateBaccaratControls();
          }
        }
      } catch (e) {
        console.error('Error loading Baccarat MM state:', e);
      }
    }
    
    // Update Baccarat controls with current state
    function updateBaccaratControls() {
      document.getElementById('targetProfit').value = baccaratMMState.targetProfit;
      document.getElementById('increment').value = baccaratMMState.increment;
      document.getElementById('commission').value = baccaratMMState.commission;
      document.getElementById('stopLoss').value = baccaratMMState.stopLoss;
      document.getElementById('attackMode').value = baccaratMMState.attackMode;
      document.getElementById('tableNotes').value = baccaratMMState.tableNotes;
      updateBaccaratDisplay();
    }
    
    // Save Baccarat MM state to Firestore
    async function saveBaccaratState() {
      try {
        const user = auth.currentUser;
        if (user) {
          await setDoc(doc(db, 'users', user.uid), {
            baccaratMMState: baccaratMMState
          }, { merge: true });
        }
      } catch (e) {
        console.error('Error saving Baccarat MM state:', e);
      }
    }
    
    // Calculate next bet amount for Baccarat MM
    function nextBaccaratBetAmount() {
      if (baccaratMMState.mode === 'Base') return state.baseUnit;
      if (baccaratMMState.mode === 'Recovery') return state.baseUnit * baccaratMMState.recoverySteps[baccaratMMState.recoveryIndex];
      if (baccaratMMState.mode === 'Attack') return state.baseUnit * baccaratMMState.attackSteps[baccaratMMState.attackIndex];
      return state.baseUnit;
    }
    
    // Update Baccarat display
    function updateBaccaratDisplay() {
      document.getElementById('nextBet').textContent = fmt(nextBaccaratBetAmount());
      document.getElementById('statCycle').textContent = `${fmt(baccaratMMState.cycleProfit)} / ${fmt(baccaratMMState.targetProfit)}`;
      document.getElementById('statMode').textContent = baccaratMMState.mode;
    }
    
    // Record Baccarat result
    function recordBaccaratResult(result) {
      if (!state.baseUnit || !state.startBankroll) {
        showMessage('Set bankroll/unit first');
        return;
      }
      
      const bet = nextBaccaratBetAmount();
      const side = 'banker';
      let pl = 0;
      
      if (result === 'W') {
        pl = side === 'banker' ? bet * (1 - baccaratMMState.commission) : bet;
      } else {
        pl = -bet;
      }
      
      // Update bankroll
      state.currentBankroll += pl;
      baccaratMMState.cycleProfit += pl;
      
      // Handle mode transitions
      autoTransitionsOnResult(result === 'W');
      
      // Check for cycle completion
      if (baccaratMMState.cycleProfit >= baccaratMMState.targetProfit) {
        baccaratMMState.targetProfit += baccaratMMState.increment;
        resetBaccaratCycle();
      }
      
      saveBaccaratState();
      updateBaccaratDisplay();
      updateMMDisplay();
    }
    
    // Auto transitions based on result
    function autoTransitionsOnResult(win) {
      if (baccaratMMState.mode === 'Base') {
        if (win) {
          baccaratMMState.baseLossStreak = 0;
        } else {
          baccaratMMState.baseLossStreak += 1;
          if (baccaratMMState.baseLossStreak >= 2) {
            baccaratMMState.mode = 'Recovery';
            baccaratMMState.recoveryIndex = 0;
          }
        }
      } else if (baccaratMMState.mode === 'Recovery') {
        if (win) {
          if (baccaratMMState.attackMode === 'on') {
            baccaratMMState.mode = 'Attack';
            baccaratMMState.attackIndex = 0;
            baccaratMMState.attackActive = true;
          } else {
            baccaratMMState.mode = 'Base';
            baccaratMMState.baseLossStreak = 0;
            baccaratMMState.recoveryIndex = 0;
          }
        } else {
          if (baccaratMMState.recoveryIndex < baccaratMMState.recoverySteps.length - 1) {
            baccaratMMState.recoveryIndex += 1;
          } else {
            baccaratMMState.mode = 'Base';
            baccaratMMState.baseLossStreak = 0;
            baccaratMMState.recoveryIndex = 0;
          }
        }
      } else if (baccaratMMState.mode === 'Attack') {
        if (win) {
          if (baccaratMMState.attackIndex < baccaratMMState.attackSteps.length - 1) {
            baccaratMMState.attackIndex += 1;
          } else {
            baccaratMMState.mode = 'Base';
            baccaratMMState.baseLossStreak = 0;
            baccaratMMState.attackIndex = 0;
            baccaratMMState.attackActive = false;
          }
        } else {
          baccaratMMState.mode = 'Base';
          baccaratMMState.baseLossStreak = 0;
          baccaratMMState.attackIndex = 0;
          baccaratMMState.attackActive = false;
        }
      }
    }
    
    // Reset Baccarat cycle
    function resetBaccaratCycle() {
      baccaratMMState.cycleProfit = 0;
      baccaratMMState.mode = 'Base';
      baccaratMMState.baseLossStreak = 0;
      baccaratMMState.recoveryIndex = 0;
      baccaratMMState.attackIndex = 0;
      baccaratMMState.attackActive = false;
      baccaratMMState.cycle += 1;
      saveBaccaratState();
      updateBaccaratDisplay();
    }
    
    // Modify setBankroll to handle Baccarat MM
    async function setBankroll() {
      const bankroll = parseFloat(document.getElementById('bankrollInput').value);
      const unit = parseFloat(document.getElementById('basebetInput').value);
      const stopProfit = parseFloat(document.getElementById('stopProfitInput').value) || 0;
      state.stopProfitType = document.getElementById('stopProfitType').value;
      state.mmSystem = document.getElementById('mmSystem').value;
      
      if (isNaN(bankroll) || bankroll <= 0 || isNaN(unit) || unit <= 0) {
        showMessage('Invalid bankroll or unit value');
        return;
      }
      
      if (stopProfit < 0) {
        showMessage('Invalid stop profit');
        return;
      }
      
      // Save Baccarat MM settings if that's the selected system
      if (state.mmSystem === 'baccarat') {
        baccaratMMState.targetProfit = int(document.getElementById('targetProfit').value, 3);
        baccaratMMState.increment = int(document.getElementById('increment').value, 0);
        baccaratMMState.commission = num(document.getElementById('commission').value, 0.05);
        baccaratMMState.stopLoss = num(document.getElementById('stopLoss').value, 0);
        baccaratMMState.attackMode = document.getElementById('attackMode').value;
        baccaratMMState.tableNotes = document.getElementById('tableNotes').value;
        
        // Reset cycle when changing settings
        resetBaccaratCycle();
      }
      
      // Rest of the setBankroll function remains the same
      snapshots.push(JSON.parse(JSON.stringify(state)));
      state.startBankroll = bankroll;
      state.baseUnit = unit;
      state.currentBankroll = bankroll;
      state.stopProfitValue = stopProfit;
      state.stopProfitEffective = state.stopProfitType === 'percentage' ? stopProfit / 100 * bankroll : stopProfit;
      state.stopProfitReached = false;
      state.betState = { currentBetUnits: 1, totalProfit: 0, cycleProfit: 0, previousLosses: [] };
      state.wins = 0;
      state.losses = 0;
      state.outcomes = [];
      
      // Save both states
      await saveMemory();
      if (state.mmSystem === 'baccarat') {
        await saveBaccaratState();
      }
      
      updateDisplay();
    }
    
    // Modify updateMMDisplay to show Baccarat MM info
    function updateMMDisplay() {
      if (state.mmSystem === 'baccarat') {
        document.getElementById('currentWager').innerText = `üíµ Current Bet: ${fmt(nextBaccaratBetAmount())}`;
        document.getElementById('streakInfo').innerText = '';
      } else {
        // Original updateMMDisplay logic for other systems
        document.getElementById('currentWager').innerText = `üíµ Current Bet: ${getWager().toFixed(2)}`;
        document.getElementById('streakInfo').innerText = state.stopProfitReached ? '' : 
          state.outcomes.slice(-3).every(v => v === 'L') ? `üßä Cold Streak - Losses: ${state.betState.previousLosses.length}` :
          state.outcomes.slice(-3).every(v => v === 'W') ? `üî• Hot Streak` : '';
      }
      
      // Rest of the display update remains the same
      document.getElementById('wins').innerText = state.wins;
      document.getElementById('losses').innerText = state.losses;
      document.getElementById('accuracy').innerText = state.wins + state.losses ? ((state.wins / (state.wins + state.losses)) * 100).toFixed(1) + '%' : '0%';
      
      const previousLosses = state.betState.previousLosses.length > 0 ? state.betState.previousLosses.join(', ') : 'None';
      const stopProfitDisplay = state.stopProfitValue > 0 ? 
        state.stopProfitType === 'percentage' ? `${state.stopProfitValue}% ($${state.stopProfitEffective.toFixed(2)})` : 
        `$${state.stopProfitValue.toFixed(2)}` : 'Not Set';
      
      document.getElementById('bankrollDisplay').innerHTML = state.startBankroll ? 
        `üíº Balance: ${state.currentBankroll.toFixed(2)} | Profit: ${(state.currentBankroll - state.startBankroll).toFixed(2)}<br>` +
        (state.mmSystem === 'baccarat' ? 
          `Bet: $${fmt(nextBaccaratBetAmount())}<br>` +
          `Mode: ${baccaratMMState.mode}<br>` +
          `Cycle: $${fmt(baccaratMMState.cycleProfit)} / $${fmt(baccaratMMState.targetProfit)}<br>` :
          `Bet: $${(state.betState.currentBetUnits * state.baseUnit).toFixed(2)} (${state.betState.currentBetUnits} units)<br>` +
          `Losses: ${previousLosses}<br>` +
          `<span class="${state.betState.cycleProfit >= 1 ? 'cycle-reset' : ''}">Cycle: $${(state.betState.cycleProfit * state.baseUnit).toFixed(2)}</span><br>` +
          `Total: $${(state.betState.totalProfit * state.baseUnit).toFixed(2)}<br>`) +
        `Stop: ${stopProfitDisplay} | ${state.stopProfitReached ? 'üö® Reached' : 'Active'}<br>` +
        `MM: ${state.mmSystem === 'plus1' ? 'Plus 1' : state.mmSystem === 'baccarat' ? 'Baccarat MM' : 'Default'}` : 
        'üíº Balance: - | Profit: -';
    }
    
    // Add the new functions to the window object
    window.toggleMMSystem = toggleMMSystem;
    window.recordBaccaratResult = recordBaccaratResult;
    window.resetBaccaratCycle = resetBaccaratCycle;
    
    // Rest of your existing code remains the same
  </script>
</body>
</html>
